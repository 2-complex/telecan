{% extends "base.html" %}
{%block title%}{%endblock%}
{%block main_content%}

<div id="masthead">
    <h1>Telecan</h1>
    Hello {{username | safe}}, (<a id="sign-out-button">sign out</a>)
</div>

<div id="games" class="tc-games"></div>

<div class="panel" id="delete-user">
    User id
    <div>
        <textarea id="delete-user-id" class="form-input"></textarea>
    </div>
    <div>
        <button id="delete-user-button">DELETE</button>
    </div>
</div>

<div class="panel" id="new-game-form">
    User (owner)
    <div>
        <textarea id="new-game-user" class="form-input"></textarea>
    </div>
    Title
    <div>
        <textarea id="new-game-title" class="form-input"></textarea>
    </div>
    Description
    <div>
        <textarea id="new-game-description" class="form-input"></textarea>
    </div>
    <div>
        <button id="new-game-button">NEW GAME</button>
    </div>
</div>

<div class="panel" id="delete-game-form">
    Game id
    <div>
        <textarea id="delete-game-id" class="form-input"></textarea>
    </div>
    <div>
        <button id="delete-game-button">DELETE GAME</button>
    </div>
</div>

<div class="panel" id="new-round-form">
    New Round of game:
    <div>
        <textarea id="new-round-game" class="form-input"></textarea>
    </div>
    User (owner)
    <div>
        <textarea id="new-round-user" class="form-input"></textarea>
    </div>
    Players
    <div>
        <textarea id="new-round-players" class="form-input"></textarea>
    </div>
    <div>
        <button id="new-round-button">NEW ROUND</button>
    </div>
</div>

<div class="panel" id="delete-round-form">
    Round id
    <div>
        <textarea id="delete-round-id" class="form-input"></textarea>
    </div>
    <div>
        <button id="delete-round-button">DELETE ROUND</button>
    </div>
</div>

<div class="panel" id="new-move-form">
    New Move in round:
    <div>
        <textarea id="new-move-round" class="form-input"></textarea>
    </div>
    User (owner)
    <div>
        <textarea id="new-move-user" class="form-input"></textarea>
    </div>
    Content
    <div>
        <textarea id="new-move-content" class="form-input"></textarea>
    </div>
    <div>
        <button id="new-move-button">NEW MOVE</button>
    </div>
</div>


<script>

function populateMoves(movesInfo, $moves)
{
    if( movesInfo.moves )
    {
        for( var i = 0; i < movesInfo.moves.length; ++i )
        {
            var moveInfo = movesInfo.moves[i];
            var $move = $("<div>");
            var $content = $("<div>");
            $content.text(moveInfo.content);
            $move.append($content);
            $moves.append($move);
        }
    }
}

function fetchRoundMoves(round_id, $moves)
{
    $.when( $.ajax({
        type: "GET",
        url: "/moves",
        dataType: "text",
        data: {"round_id":round_id,},
    })).then(
        function(result)
        {
            populateMoves(JSON.parse(result), $moves);
        }
    ).fail(
        function()
        {
           $moves.append("Moves not found");
        }
    );
}

function connectRoundClickHandler($round, roundId, $link)
{
    $link.addClass("tc-expander");
    $link.click(
        function(evt)
        {
            if( $round.hasClass("tc-expanded") )
            {
                $round.find(".tc-moves").remove();
                $round.removeClass("tc-expanded")
            }
            else
            {
                var $moves = $("<div>").addClass("tc-moves");
                $round.append($moves);
                fetchRoundMoves(roundId, $moves);
                $round.addClass("tc-expanded")
            }
        }
    );
}

function populateRounds(roundsInfo, $rounds)
{
    if( roundsInfo.rounds )
    {
        for( var i = 0; i < roundsInfo.rounds.length; ++i )
        {
            var roundInfo = roundsInfo.rounds[i];
            var $round = $("<div>");
            var $idspan = $("<span>").addClass("tc-section-title");
            $idspan.text(roundInfo.id);
            var $title = $("<div>");
            $title.append($idspan);
            $round.append($title);

            for( var i = 0; i < roundInfo.players.length; ++i )
            {
                var $namespan = $("<span>");
                $namespan.addClass("tc-section-title");
                $namespan.text(roundInfo.players[i].username);
                $title.append($namespan);
            }
            $rounds.append($round);

            connectRoundClickHandler($round, roundInfo.id, $title);
        }
    }
}

function fetchGameRounds(game_id, $rounds)
{
    $.when( $.ajax({
        type: "GET",
        url: "/rounds",
        dataType: "text",
        data: {"game_id":game_id,},
    })).then(
        function(result)
        {
            populateRounds(
                JSON.parse(result),
                $rounds
            );
        }
    ).fail(
        function()
        {
           $rounds.append("Rounds not found");
        }
    );
}

function connectGameClickHandler($game, gameId, $link)
{
    $link.addClass("tc-expander");
    $link.click(
        function(evt)
        {
            if( $game.hasClass("tc-expanded") )
            {
                $game.find(".tc-rounds").remove();
                $game.removeClass("tc-expanded");
            }
            else
            {
                var $rounds = $("<div>").addClass("tc-rounds");
                $game.append($rounds);
                fetchGameRounds(gameId, $rounds);
                $game.addClass("tc-expanded");
            }
        }
    );
}

function populateGames(gamesInfo)
{
    if( gamesInfo.games )
    {
        for( var i = 0; i < gamesInfo.games.length; ++i )
        {
            var gameInfo = gamesInfo.games[i];
            var $game = $("<div>");
            var $title = $("<span>");
            $title.addClass("tc-section-title")
            $title.text(gameInfo.title);
            $game.append( $title );
            $("#games").append($game);

            connectGameClickHandler($game, gameInfo.id, $title);
        }
    }
}

function fetchGames()
{
    $.when( $.ajax({
        type: "GET",
        url: "/games",
        dataType: "text",
        data: {"username":"{{username | safe}}",},
    })).then(
        function(result)
        {
            populateGames(JSON.parse(result));
        }
    ).fail(
        function()
        {
           $("#games").append("Games not found");
        }
    );
}

function refresh()
{
    $("#sign-out-button").click(
        function(evt)
        {
            $.when( $.ajax({
                type: "POST",
                url: "/sign-out",
                dataType: "text",
                data: {},
            })).then(
                function(result)
                {
                    window.location.href = ""
                }
            ).fail(
                function()
                {
                    window.location.href = ""
                }
            );
        }
    )

    $("#games").empty();
    fetchGames();
}

$(document).ready(refresh);
</script>

{%endblock%}
