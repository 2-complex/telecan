{% extends "base.html" %}
{%block title%}{%endblock%}
{%block main_content%}

<div id="masthead">
    <h1>Telecan</h1>
</div>

<div id="games" class="game-list"></div>

<script>

function populateMoves(movesInfo, $moves)
{
    if( movesInfo.moves )
    {
        for( var i = 0; i < movesInfo.moves.length; ++i )
        {
            var moveInfo = movesInfo.moves[i];
            var $move = $("<div>");
            var $content = $("<div>");
            $content.text(moveInfo.content);
            $move.append($content);
            $moves.append($move);
        }
    }
}

function fetchRoundMoves(round_id, $moves)
{
    $.when( $.ajax({
        type: "GET",
        url: "/moves",
        dataType: "text",
        data: {"round_id":round_id,},
    })).then(
        function(result)
        {
            populateMoves(JSON.parse(result), $moves);
        }
    ).fail(
        function()
        {
           $moves.append("Moves not found");
        }
    );
}

function connectRoundClickHandler($round, roundId)
{
    $round.click(
        function(evt)
        {
            $round.find(".tc-moves").remove();
            var $moves = $("<div>").addClass("tc-moves");
            $round.append($moves);
            fetchRoundMoves(roundId, $moves);
        }
    );
}

function populateRounds(roundsInfo, $rounds)
{
    if( roundsInfo.rounds )
    {
        for( var i = 0; i < roundsInfo.rounds.length; ++i )
        {
            var roundInfo = roundsInfo.rounds[i];
            var $round = $("<div>");
            var $idspan = $("<span>");
            $idspan.text(roundInfo.id);
            $round.append($idspan);

            for( var i = 0; i < roundInfo.players.length; ++i )
            {
                var $namespan = $("<span>");
                $namespan.text(roundInfo.players[i].username);
                $round.append($namespan);
            }
            $rounds.append($round);

            connectRoundClickHandler($round, roundInfo.id);
        }
    }
}

function fetchGameRounds(game_id, $rounds)
{
    $.when( $.ajax({
        type: "GET",
        url: "/rounds",
        dataType: "text",
        data: {"game_id":game_id,},
    })).then(
        function(result)
        {
            populateRounds(
                JSON.parse(result),
                $rounds
            );
        }
    ).fail(
        function()
        {
           $rounds.append("Rounds not found");
        }
    );
}

function connectGameClickHandler($game, gameId, $link)
{
    $link.click(
        function(evt)
        {
            $game.find(".tc-rounds").remove();
            var $rounds = $("<div>").addClass("tc-rounds");
            $game.append($rounds);
            fetchGameRounds(gameId, $rounds);
        }
    );
}

function populateGames(gamesInfo)
{
    if( gamesInfo.games )
    {
        for( var i = 0; i < gamesInfo.games.length; ++i )
        {
            var gameInfo = gamesInfo.games[i];
            var $game = $("<div>");
            var $title = $("<div>");
            $title.text(gameInfo.title);
            $game.append( $title );
            $("#games").append($game);

            connectGameClickHandler($game, gameInfo.id, $title);
        }
    }
}

function fetchGames()
{
    $.when( $.ajax({
        type: "GET",
        url: "/games",
        dataType: "text",
        data: {"username":"{{username | safe}}",},
    })).then(
        function(result)
        {
            populateGames(JSON.parse(result));
        }
    ).fail(
        function()
        {
           $("#games").append("Games not found");
        }
    );
}

function refresh()
{
    $("#games").empty();
    fetchGames();
}

$(document).ready(refresh);
</script>

{%endblock%}
