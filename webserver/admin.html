<html>

<head>
<title>Admin</title>
</head>

<body>

<table style="background:#dde">

<tr>
<td valign=top>

<div style="margin-top:0px">	
	<a onclick="submit_all_users()" href="#">Users</a><br/>
	<div style="height:200px; width:100px; background:#ccd; color:#001;" id="output"></div>
<div>

</td>
<td>

<div id="content">
<table cellpadding=10>
<tr>
<td valign="bottom"><div id="userstable_title"></div></td>
<td valign="bottom"><div id="requeststable_title"></div></td>
<td valign="bottom"><div id="movestable_title"></div></td>
</tr>
<tr>
<td valign="top"><table border=1 cellspacing=0 cellpadding=3 id="userstable"></table></td>
<td valign="top"><table border=1 cellspacing=0 cellpadding=3 id="requeststable"></table></td>
<td valign="top">
	<div id="game_data_div">
	</div>
	<table border=1 cellspacing=0 cellpadding=3 id="movestable">
	</table>
</td>
</tr>
</table>
</div>

<div id="turn_info"></div>
</td>
</tr>

</table>

<script language="javascript">

var output = document.getElementById('output');
var games = document.getElementById('games');
var turn_info = document.getElementById('turn_info');
var userform = document.getElementById('userform');
var content = document.getElementById('content');

var userstable_title = document.getElementById('userstable_title');
var userstable = document.getElementById('userstable');

var requeststable_title = document.getElementById('requeststable_title');
var requeststable = document.getElementById('requeststable');

var movestable_title = document.getElementById('movestable_title');
var movestable = document.getElementById('movestable');
var game_data_div = document.getElementById('game_data_div');

function param_string_for_form(form)
{
	var params = [];
	for(var i = 0; i < form.elements.length; i++) {
		var element = form.elements[i];
		params = params.concat(element.name + '=' + element.value.replace(' ', '%20'));
	}
	
	return params.join('&');
}

function submit_all_users()
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = handle_all_users
	http.open("GET", "cgi-bin/allusers.py?", true);
	http.send(null);
	
	return false;
}

function clear_table(table)
{
	if( table == userstable )
	{
		userstable_title.innerHTML = "";
	}
	
	if( table == requeststable )
	{
		requeststable_title.innerHTML = "";
	}
	
	if( table == movestable )
	{
		movestable_title.innerHTML = "";
	}
	
	while( table.rows.length )
	{
		table.deleteRow(0);
	}
	
	remove_all_children(game_data_div);
}

function handle_all_users()
{
	if(this.readyState == 4 && this.status == 200)
	{
		var users = JSON.parse(this.responseText);
		if( users.error )
		{
			output.innerText = users.error;
		}
		else
		{
			clear_table(userstable);
			clear_table(requeststable);
			clear_table(movestable);
			
			var table = userstable;
			userstable_title.innerHTML = "All Users";
			
			var row = table.insertRow(0);
			row.insertCell(0).innerHTML = "name";
			row.insertCell(1).innerHTML = "password";
			row.insertCell(2).innerHTML = "data";
			row.bgColor = '#eee';
			
			for (var i = 0; i < users.length; i++)
			{
				user = users[i];
				
				var row = table.insertRow(table.rows.length);
				row.bgColor = "#fff";
				
				var d = document.createElement("div");
				d.innerHTML = '<a onclick="submit_user_requests(\'' + user.name +
						'\');" href="#">' + user.name + "</a>\n";
				row.insertCell(0).appendChild(d);
				
				row.insertCell(1).innerText = user.pswd;
 				
 				var cell = row.insertCell(2);
				var element = document.createElement("textarea");
				element.value = user.data;
				cell.appendChild(element);
			}
		}
	}
}


function submit_user_requests(name)
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = handle_user_requests;
	http.open("GET", "cgi-bin/userrequests.py?name=" + name, true);
	http.send(null);
	
	return false;
}

function highlight(table, column, value)
{
	for (var i = 1; i < table.rows.length; i++ )
	{
		var row = table.rows[i];
		if( row.cells && row.cells[column] && row.cells[column].innerText == value )
		{
			row.bgColor = "#aff";
		}
		else
		{
			row.bgColor = "#fff";
		}
	}
}

function remove_row(table, index)
{
	for(var i = 1; i < table.rows.length; i++)
	{
		row = table.rows[i];
		if( row.name == 'row_' + index )
		{
			table.deleteRow(i);
			return;
		}
	}
}

function handle_user_requests()
{
	if( this.readyState == 4 && this.status == 200 )
	{
		var requests_info = JSON.parse(this.responseText);
		if( requests_info.error )
		{
			output.innerText = requests_info.error;
		}
		else
		{
			clear_table(requeststable);
			clear_table(movestable);
			
			var requests = requests_info.requests;
			var user = requests_info.user;
			
			var table = requeststable;
			requeststable_title.innerHTML = user;
			
			highlight(userstable, 0, user + "\n");
			
			var row = table.insertRow(0);
			row.insertCell(0).innerHTML = "player";
			row.insertCell(1).innerHTML = "title";
			row.insertCell(2).innerHTML = "n.o.p";
			row.insertCell(3).innerHTML = "game";
			row.bgColor = '#eee';
			
			for (var i = 0; i < requests.length; i++)
			{
				request = requests[i];
				
				var row = table.insertRow(table.rows.length);
				row.bgColor = "#fff";
				
				row.insertCell(0).innerText = request.user;
				row.insertCell(1).innerText = request.title;
				row.insertCell(2).innerText = request.number_of_players;
				
				if( request.game != "''" )
				{
					var d = document.createElement("div");
					d.innerHTML = '<a onclick="submit_game_moves(\'' + request.game +
							'\');" href="#">' + request.game + "</a>\n";
					row.insertCell(3).appendChild(d);
				}
				else
				{
					row.insertCell(3).innerText = request.game;
				}
 			}
		}
	}
}


function submit_game_moves(game)
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = handle_game_moves;
	http.open("GET", "cgi-bin/gamemoves.py?game=" + game, true);
	http.send(null);
	
	return false;
}

function remove_all_children(node)
{
	while(node.hasChildNodes())
	{
		node.removeChild(node.lastChild);
	}
}

function handle_game_moves()
{
	if( this.readyState == 4 && this.status == 200 )
	{
		var moves_info = JSON.parse(this.responseText);
		if( moves_info.error )
		{
			output.innerText = moves_info.error;
		}
		else
		{
			clear_table(movestable);
			
			var game = moves_info.game;
			var data = moves_info.data;
			var moves = moves_info.moves;
			
			var table = movestable;
			movestable_title.innerHTML = game;
			
			remove_all_children(game_data_div);
			
			var a = document.createElement("textarea");
			a.value = data;
			game_data_div.appendChild(a);
			
			var d = document.createElement("div");
			d.innerHTML = '<a onclick="submit_delete_game(\'' + game +
					'\');" href="#">X</a>\n';
			game_data_div.appendChild(d);
			
			highlight(requeststable, 3, game + "\n");
			
			var row = table.insertRow(0);
			row.insertCell(0).innerHTML = "player";
			row.insertCell(1).innerHTML = "data";
			row.insertCell(2).innerHTML = "delete";
			row.bgColor = '#eee';
			
			for (var i = 0; i < moves.length; i++)
			{
				move = moves[i];
				
				var row = table.insertRow(table.rows.length);
				row.name = "row_" + i;
				row.bgColor = "#fff";
				
				row.insertCell(0).innerText = move.player;
				
				var cell = row.insertCell(1);
				var element = document.createElement("textarea");
				element.value = move.data;
				cell.appendChild(element);
				
				var d = document.createElement("div");
				d.innerHTML = '<a onclick="submit_delete_move(\'' + move.id +
						'\'); remove_row(movestable, ' + i + ');" href="#">X</a>\n';
				row.insertCell(2).appendChild(d);
 			}
		}
	}
}

function submit_delete_move(id)
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = handle_delete;
	http.open("GET", "cgi-bin/delete.py?object=Move%20" + id, true);
	http.send(null);
	
	return false;
}

function submit_delete_game(identifier)
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = handle_delete;
	http.open("GET", "cgi-bin/delete.py?object=" + identifier.replace(" ", "%20"), true);
	http.send(null);
	
	return false;
}

function handle_delete()
{
	if(this.readyState == 4 && this.status == 200)
	{
		var response = JSON.parse(this.responseText);
		if( response.error )
		{
			output.innerText = response.error;
		}
		else
		{
		}
	}
}


</script>

</body>

</html>

