<html>

<head>
<title> Tic Tac Toe </title>
</head>

<body>

<table style="background:#dde">

<tr>
<td valign=top>

<div style="margin-top:0px">
	<div style="height:200px; background:#ccd; color:#001;" id="output"></div>
	
	<div>
	<hr/>
	<form id="userform" action="cgi-bin/newuser.py" method="get">
	name: <input type="text" name="name" /><br />
	pswd: <input type="password" name = "pswd" /><br />
	</form>
	</div>
	
	
	<a onclick="submit_new_user()" href="#">New User</a><br/>
	
	<a onclick="submit_request()" href="#">New Game Request</a><br/>
	
	<a onclick="refresh_games()" href="#">Refresh Games</a><br/>
	
	<hr/>
	
	Games
	<div id="games">
	</div>
<div>

</td>
<td>
<div id = "refresh">refresh</div>
<canvas id="square" style="width:600px; height:600px" height=600 width=600>
alternate canvas text
</canvas><br/>
<div id="turn_info"></div>
</td>
</tr>

</table>

<script language="javascript">

var output = document.getElementById('output');
var games = document.getElementById('games');
var turn_info = document.getElementById('turn_info');
var userform = document.getElementById('userform');
var gameform = document.getElementById('userform');
var refresh = document.getElementById('refresh');

function param_string_for_form(form)
{
	var params = [];
	for(var i = 0; i < form.elements.length; i++) {
		var element = form.elements[i];
		params = params.concat(element.name + '=' + element.value.replace(' ', '%20'));
	}
	
	return params.join('&');
}

function print_status()
{
	if(this.readyState == 4 && this.status == 200) {
		var info = JSON.parse(this.responseText);
		output.innerText = info.status;
	}
}

function submit_new_user()
{	
	var http = new XMLHttpRequest();
	http.onreadystatechange = print_status
	http.open("GET", "cgi-bin/newuser.py?"+param_string_for_form(userform), true);
	http.send(null);
	
	return false;
}

function submit_request()
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = print_status
	http.open("GET", "cgi-bin/request.py?"+param_string_for_form(userform)+"&title=TicTacToe&number_of_players=2", true);
	http.send(null);
	
	refresh_games();
	
	return false;
}

function make_move(game, data)
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = print_status
	http.open("GET", "cgi-bin/move.py?"+param_string_for_form(userform)+"&game=" + game + "&data=" + data, true);
	http.send(null);
}


function handle_move_list()
{
	if(this.readyState == 4 && this.status == 200) {
		var moves = JSON.parse(this.responseText);
		if( moves.error )
		{
			output.innerText = moves.error;
		}
		else
		{
			var xplayer = '';
			var oplayer = '';
			
			var you = userform.elements['name'].value;
			
			if( moves.length == 0 )
			{
				xplayer = you;
			}
			
			for (var i = 0; i < moves.length; i++)
			{
				move_info = moves[i];
				if (xplayer == '')
				{
					xplayer = move_info.player;
				}
				if (xplayer != '' && oplayer == '' && move_info.player != xplayer)
				{
					oplayer = move_info.player;
				}
				if( xplayer != you )
				{
					oplayer = you;
				}
				
				if ( move_info.data != 'None' )
				{
					var x = eval(move_info.data[0]);
					var y = eval(move_info.data[1]);
					
					if ( move_info.player == xplayer )
					{
						board[x][y] = 'x';
						drawX(x, y);
					}
					else
					{
						board[x][y] = 'o';
						drawO(x, y);
					}
				}
			}
			
			piece = getCurrentPiece();
			
			html_string = ""
			
			
			var winner = handleWinner();
			
			if ( (winner == 'x' && you == xplayer) || (winner == 'o' && you == oplayer) )
			{
				html_string = "YOU WIN!";
				yourturn = false;
			}
			else if (winner)
			{
				html_string = "you lose";
				yourturn = false;
			}
			else
			{
				if ((piece == 'x' && you == xplayer) || (piece == 'o' && you == oplayer))
				{
					html_string += "YOUR TURN<br/>";
					yourturn = true;
				}
				else
				{
					html_string += "their turn<br/>";
					yourturn = false;
					drawScreen();
				}
				
				if( you==xplayer )
				{
					html_string += "You are X<br/>";
				}
				else
				{
					html_string += "You are O<br/>";
				}
			}
			
			turn_info.innerHTML = html_string;
		}
	}
}

function sync_with_game(game)
{
	clearBoard();
	drawGrid();
	
	current_game = game;
	
	var http = new XMLHttpRequest();
	http.onreadystatechange = handle_move_list
	http.open("GET", "cgi-bin/movelist.py?"+param_string_for_form(userform)+"&game=" + game, true);
	http.send(null);
	
	refresh.innerHTML = '<a onclick="sync_with_game(' + game + ');" href="#">refresh</a><br/>';
	
	return false;
}

function handle_request_list()
{
	if(this.readyState == 4 && this.status == 200) {
		var requests = JSON.parse(this.responseText);
		if( requests.error )
		{
			output.innerText = requests.error;
		}
		else
		{
			games.innerHTML = "";
			for (var i = 0; i < requests.length; i++)
			{
				request_info = requests[i];
				if ( request_info.game && request_info.players )
				{
					games.innerHTML += '<a onclick="sync_with_game(' + request_info.game +
						');" href="#">' + request_info.players.join(' vs. ') + "</a>\n";
				}
				else
				{
					games.innerHTML += "Outstanding request\n";
				}
				
				games.innerHTML += "--- " + request_info.created_at + " <br/>"
			}
		}
	}
}

function refresh_games()
{
	var http = new XMLHttpRequest();
	http.onreadystatechange = handle_request_list
	http.open("GET", "cgi-bin/requestlist.py?"+param_string_for_form(userform)+"&title=TicTacToe", true);
	http.send(null);
	
	return false;
}


function mouseCoordinates(event)
{
	var posx = 0;
	var posy = 0;
	
	if (!event)
		var e = window.event;
	
	if (event.offsetX)
	{
		posx = event.offsetX;
		posy = event.offsetY;
	}
	else if (event.clientX || event.clientY)
	{
		posx = e.clientX + document.body.scrollLeft
			+ document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop
			+ document.documentElement.scrollTop;
	}
	
	return [posx, posy];
}

var canvas = document.getElementById('square');
var context = canvas.getContext('2d');


function clearBoard()
{
	for (var i = 0; i < 3; i++)
	{
		for (var j = 0; j < 3; j++)
		{
			board[i][j] = ' ';
		}	
	}
}

function drawGrid()
{
	context.fillStyle="#e0e0e0";
	context.fillRect(0, 0, 600, 600);

	context.strokeStyle="#000000";
	context.lineWidth = 2;
	for (var i=0; i<=3; i++)
	{
		context.beginPath();
		context.moveTo(200*i, 0); // give the (x,y) coordinates
		context.lineTo(200*i, 600);
		context.stroke();
		
		context.beginPath();
		context.moveTo(0, 200*i); // give the (x,y) coordinates
		context.lineTo(600, 200*i);
		context.stroke();
	}
}

function drawScreen()
{
	context.fillStyle="rgba(150, 150, 150, 0.6)";
	context.fillRect(0, 0, 600, 600);
}

function drawX(x, y)
{
	context.strokeStyle="#0055ff";
	context.lineWidth = 20;
	context.save()
	context.translate(100+200*x,100+200*y);
	context.beginPath();
	context.moveTo(-70, 70); // give the (x,y) coordinates
	context.lineTo(70, -70);
	context.moveTo(-70, -70); // give the (x,y) coordinates
	context.lineTo(70, 70);
	context.stroke();
	context.restore()
}


function drawO(x, y)
{
	context.strokeStyle="#cc6600";
	context.lineWidth = 20;
	context.save();
	context.translate(100+200*x,100+200*y);
	context.beginPath();

	var facets = 100;
	var r = 70;
	context.moveTo(r, 0);
	for (var i = 0; i <= facets; i++)
	{
		var theta = i * 2.0 * Math.PI / facets;
		s = Math.sin(theta);
		c = Math.cos(theta);
		
		context.lineTo(r * c, r * s);
	}
	
	context.stroke();
	context.restore();
}


yourTurn = true;
board = [[' ', ' ', ' '],[' ', ' ', ' '],[' ', ' ', ' ']];


function check(a,b,c,d,e,f)
{
	var s = board[a][b] + board[c][d] + board[e][f];
	if( s == 'xxx' )
		return {winner: 'x', strike1: [a,b], strike2: [e,f]};
	
	if( s == 'ooo' )
		return {winner: 'o', strike1: [a,b], strike2: [e,f]};
	
	return null;
}

function drawStrike(x0, y0, x1, y1)
{
	context.strokeStyle="rgba(250, 200, 0, 0.7)";
	context.lineWidth = 40;
	context.beginPath();
	context.moveTo(100+200*x0,100+200*y0); // give the (x,y) coordinates
	context.lineTo(100+200*x1,100+200*y1);
	context.stroke();
}

function handleWinner()
{
	var winner_info =
		check(0,0, 1,1, 2,2) ||
		check(2,0, 1,1, 0,2) ||
		
		check(0,0, 1,0, 2,0) ||
		check(0,1, 1,1, 2,1) ||
		check(0,2, 1,2, 2,2) ||
		
		check(0,0, 0,1, 0,2) ||
		check(1,0, 1,1, 1,2) ||
		check(2,0, 2,1, 2,2);
	
	if (winner_info) {
		var p = winner_info.strike1;
		var q = winner_info.strike2;
		drawStrike(p[0], p[1], q[0], q[1]);
	}
	
	return winner_info && winner_info.winner;
}

function getCurrentPiece()
{
	var turnnumber = 0;
	for( var i = 0; i < 3; i++ )
	for( var j = 0; j < 3; j++ )
	{
		if( board[i][j] != ' ' )
			turnnumber++;
	}
	
	return (turnnumber%2)?'o':'x';
}

var yourturn = true;
var current_game = 0;

canvas.addEventListener("click", function(event)
{
	var mouseX, mouseY;
	var p = mouseCoordinates(event);
	
	if ( yourturn )
	{
		var x = Math.floor(p[0] / 200);
		var y = Math.floor(p[1] / 200);
		
		var piece = getCurrentPiece();
		
		if( board[x][y] == ' ' )
		{
			if( piece == 'x')
				drawX(x, y);
			else
				drawO(x, y);
			board[x][y] = piece;
			
			drawScreen();
			make_move(current_game, '' + x + '' + y);
			
			yourturn = false;
			turn_info.innerHTML = "MOVE MADE<br/>"
		}
	}
});


drawGrid();


</script>

</body>

</html>

